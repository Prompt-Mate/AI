# ============================================================
# 0) ê¸°ë³¸ import
# ============================================================
from fastapi import FastAPI
from pydantic import BaseModel
from llama_cpp import Llama
import json


# ============================================================
# 1) FastAPI app
# ============================================================
app = FastAPI(
    title="Prompt Judge API",
    description="í”„ë¡¬í”„íŠ¸ í’ˆì§ˆ JSON í‰ê°€ ëª¨ë¸",
    version="1.0.0"
)


# ============================================================
# 2) GGUF Judge ëª¨ë¸ ë¡œë“œ 
# ============================================================
MODEL_PATH = "/home/ubuntu/models/model-q4-feedback.gguf"  # <- ë„ˆê°€ ì˜¬ë¦° ì´ë¦„

print("ğŸ”„ Loading Judge Model...")
judge_llm = Llama(
    model_path=MODEL_PATH,
    n_threads=8,
    n_ctx=4096,
    verbose=False
)
print("âœ… Judge Model Ready")



def build_judge_prompt(user_prompt: str) -> str:
    return f"""
ë„ˆëŠ” ì‚¬ìš©ìê°€ ì‘ì„±í•œ í”„ë¡¬í”„íŠ¸ì˜ì˜ í’ˆì§ˆì„ í‰ê°€í•˜ëŠ” ìë™ ì±„ì ê¸°ì´ë‹¤.
ë‹µë³€ì„ ìƒì„±í•˜ì§€ ë§ê³ , í”„ë¡¬í”„íŠ¸ ìì²´ë§Œ í‰ê°€í•œë‹¤.

âš ï¸ ì¶œë ¥ ê·œì¹™ (ì ˆëŒ€ ìœ„ë°˜ ê¸ˆì§€)
- ë°˜ë“œì‹œ JSON ê°ì²´ 1ê°œë§Œ ì¶œë ¥í•œë‹¤
- JSON ì•ë’¤ë¡œ ì–´ë–¤ ë¬¸ìë„ ì¶œë ¥í•˜ì§€ ì•ŠëŠ”ë‹¤
- ì„¤ëª…, ë¬¸ì¥, ë§ˆí¬ë‹¤ìš´, ì œëª©, ì£¼ì„ ì¶œë ¥ ê¸ˆì§€
================================================================
# í‰ê°€ ê¸°ì¤€ (0~100)
================================================================
1) ëª…í™•ì„±
- ëª©í‘œê°€ ë¶„ëª…í•˜ì§€ ì•Šìœ¼ë©´ ê°ì í•œë‹¤.
- ì—¬ëŸ¬ í•´ì„ì´ ê°€ëŠ¥í•œ í‘œí˜„ì„ ê°ì í•œë‹¤.

2) êµ¬ì²´ì„±
- ëˆ„ê°€ / ë¬´ì—‡ì„ / ì–¸ì œ / ì–´ë””ì„œ / ì™œ / ì–´ë–»ê²Œ ì¤‘
  ë¹ ì§„ ìš”ì†Œë§ˆë‹¤ ê°ì í•œë‹¤.
- ì¶œë ¥ í˜•íƒœë‚˜ ë¶„ëŸ‰ ì§€ì‹œê°€ ì—†ìœ¼ë©´ ê°ì í•œë‹¤.
- ì œì•½ ì¡°ê±´ì´ ì—†ìœ¼ë©´ ê°ì í•œë‹¤.

3) êµ¬ì„±
- ì§€ì‹œë¬¸, ë§¥ë½, ì œì•½ ì¡°ê±´, ì¶œë ¥ í˜•íƒœê°€
  ì²´ê³„ì ìœ¼ë¡œ êµ¬ì„±ë˜ì§€ ì•Šìœ¼ë©´ ê°ì í•œë‹¤.

4) ì–¸ì–´ í’ˆì§ˆ
- ë¬¸ë²•ì ìœ¼ë¡œ ì–´ìƒ‰í•œ ë¬¸ì¥ì„ ê°ì í•œë‹¤.
- ìì—°ìŠ¤ëŸ½ì§€ ì•Šì€ í‘œí˜„ì„ ê°ì í•œë‹¤.

5) ì¼ê´€ì„±
- ì„œë¡œ ì¶©ëŒí•˜ëŠ” ìš”êµ¬ê°€ ìˆìœ¼ë©´ í¬ê²Œ ê°ì í•œë‹¤.
- í•˜ë‚˜ì˜ ì˜ë¯¸ë¡œ í•´ì„ë˜ì§€ ì•Šìœ¼ë©´ ê°ì í•œë‹¤.

================================================================
# í•œêµ­ì–´ ì „ìš© ê·œì¹™
================================================================
- ëª¨ë“  ì½”ë©˜íŠ¸ì™€ í”¼ë“œë°±ì€ 100% ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ë¡œ ì‘ì„±í•œë‹¤.
- ì˜ì–´ ë‹¨ì–´, ì•½ì–´, ê¸°í˜¸ í‘œí˜„ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤.
- "ì¼ë¶€", "ì•½ê°„", "ì¡°ê¸ˆ", "ë‹¤ì†Œ", "ì• ë§¤í•¨", "ë¶€ë¶„ì ìœ¼ë¡œ" ê°™ì€ í‘œí˜„ì„ ì“°ì§€ ì•ŠëŠ”ë‹¤.
- ëª¨ë“  ì§€ì ì€ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•´ì•¼ í•œë‹¤.

================================================================
# ì›ë¬¸ ì˜ë„ ë³´ì¡´ ê·œì¹™
================================================================
- ì›ë¬¸ í”„ë¡¬í”„íŠ¸ì˜ í•µì‹¬ ì˜ë„ë¥¼ ì ˆëŒ€ë¡œ ë³€ê²½í•˜ê±°ë‚˜ í™•ì¥í•˜ì§€ ë§ˆë¼.
- ìƒˆë¡œìš´ ëª©ì ì´ë‚˜ ì‘ì—…ì„ ì œì•ˆí•˜ì§€ ë§ˆë¼.
- ëŒ€ìƒ ë…ìë‚˜ ì‚¬ìš© ìƒí™©ì„ ì„ì˜ë¡œ ì¶”ê°€í•˜ì§€ ë§ˆë¼.
- ì›ë¬¸ì— ì—†ëŠ” ë§¥ë½ì„ ê°€ì •í•˜ì§€ ë§ˆë¼.

ê°œì„  í”¼ë“œë°±ì€ ë‹¤ìŒ ë²”ìœ„ ì•ˆì—ì„œë§Œ ì‘ì„±í•œë‹¤:
- í‘œí˜„ì„ ë” ëª…í™•í•˜ê²Œ ë§Œë“œëŠ” ë°©í–¥
- ë¹ ì§„ ì •ë³´ë¥¼ ë³´ì™„í•˜ë„ë¡ ì•ˆë‚´
- ì¶œë ¥ í˜•íƒœë‚˜ ì œì•½ ì¡°ê±´ì„ ëª…í™•íˆ í•˜ë„ë¡ ì•ˆë‚´

================================================================
# overall_score ê³„ì‚° ê·œì¹™
================================================================
overall_score = round(
    (clarity_score + specificity_score + structure_score +
     language_score + consistency_score) / 5
)

================================================================
# JSON ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ ì´ êµ¬ì¡°ë§Œ ì‚¬ìš©)
================================================================
{{
  "overall_score": <0-100>,
  "clarity_score": <0-100>,
  "specificity_score": <0-100>,
  "structure_score": <0-100>,
  "language_score": <0-100>,
  "consistency_score": <0-100>,
  "clarity_comment": "<ëª…í™•ì„± í‰ê°€ ë° ê°œì„  ì¡°ì–¸>",
  "specificity_comment": "<êµ¬ì²´ì„± í‰ê°€ ë° ê°œì„  ì¡°ì–¸>",
  "structure_comment": "<êµ¬ì„± í‰ê°€ ë° ê°œì„  ì¡°ì–¸>",
  "language_comment": "<ì–¸ì–´ í’ˆì§ˆ í‰ê°€ ë° ê°œì„  ì¡°ì–¸>",
  "consistency_comment": "<ì¼ê´€ì„± í‰ê°€ ë° ê°œì„  ì¡°ì–¸>",
  "summary_feedback": "<ì „ì²´ í”„ë¡¬í”„íŠ¸ë¥¼ ê°œì„ í•˜ê¸° ìœ„í•œ í•µì‹¬ ì¡°ì–¸>"
}}

================================================================
# í‰ê°€ ëŒ€ìƒ í”„ë¡¬í”„íŠ¸
================================================================
{user_prompt}
""".strip()


# ============================================================
# 4) ìƒì„± í•¨ìˆ˜
# ============================================================
def judge_generate(prompt: str) -> str:
    res = judge_llm(
        f"<s>[INST] {prompt} [/INST]",
        max_tokens=512,
        temperature=0.0,
        top_p=1.0,
        stop=["</s>"]
    )
    return res["choices"][0]["text"].strip()


# ============================================================
# 5) JSON íŒŒì„œ (ë„¤ê°€ ë§Œë“ ê±° ê·¸ëŒ€ë¡œ ìœ ì§€)
# ============================================================
def safe_json_extract(text: str) -> dict:
    match = re.search(r"\{[\s\S]*\}", text)

    if not match:
        return {
            "error": "MODEL_OUTPUT_NOT_JSON",
            "raw_output": text[:1500]
        }

    json_text = match.group()

    try:
        return json.loads(json_text)
    except Exception:
        try:
            fixed = (
                json_text
                .replace("\n", " ")
                .replace(",}", "}")
                .replace(",]", "]")
            )
            return json.loads(fixed)
        except Exception as e:
            return {
                "error": "JSON_PARSE_FAILED",
                "raw_output": text[:1500],
                "exception": str(e)
            }


# ============================================================
# 6) ì™¸ë¶€ í˜¸ì¶œ í•¨ìˆ˜
# ============================================================
def evaluate_prompt_only(prompt:str)->dict:
    result = judge_generate(build_judge_prompt(prompt))
    return safe_json_extract(result)


# ============================================================
# 7) API Endpoint
# ============================================================
class JudgeRequest(BaseModel):
    prompt: str


@app.post("/judge")
def judge(req: JudgeRequest):
    result = evaluate_prompt_only(req.prompt)

    if "error" in result:
        return {
            "status": "fail",
            "reason": result["error"],
            "raw_output": result.get("raw_output", "")
        }

    return {
        "status": "success",
        "result": result
    }


@app.get("/health")
def health():
    return {"status": "judge ok"}

